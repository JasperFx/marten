<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Marten - Copy and transform stream</title>
    <link href="/marten/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="/marten/content/prism.css" rel="stylesheet" type="text/css" />
    <link href="/marten/content/theme.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />

    <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

    <!-- CSS code from Bootply.com editor -->
    <link href="/marten/content/affix.css" rel="stylesheet" type="text/css" />
</head>

<!-- HTML code from Bootply.com editor -->

<body>
    <a href="https://github.com/jasperfx/marten"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

    <nav class="navbar navbar-default navbar-fixed-top" role="banner">
        <div class="container">
            <div class="navbar-header">
                <a href="/marten" class="navbar-brand">Marten 3.6.1</a>
            </div>
            <nav class="collapse navbar-collapse" role="navigation">
                <ul class="nav navbar-nav pull-right">
                    <li>
                        <a href="/marten/getting_started">Getting Started</a>
                    </li>
                    <li>
                        <a href="/marten/documentation">Documentation</a>
                    </li>
                    <li>
                        <a href="/marten/migration_guide">Migration Guide</a>
                    </li>
                    <li>
                        <a href="https://gitter.im/jasperfx/marten?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/marten" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/marten_lib?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @marten_lib</a>
                        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    </li>
                    <li><a href="/marten/documentation/scenarios/aggregates_events_repositories" title="Aggregates, Events, Repositories">Previous</a></li>
                <li><a href="/marten/documentation/scenarios/immutable_projections_readmodel" title="Immutable projections as read model">Next</a></li>
                </ul>
                <div class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <input id="search" type="search" class="form-control" placeholder="Search">
                    </div>
                </div>
            </nav>
        </div>
    </nav>
    <div class="container">
        <nav class="navbar-inverse">
            <ol class="breadcrumb"><li><a href="/marten/">Marten</a></li><li><a href="/marten/documentation">Documentation</a></li><li><a href="/marten/documentation/scenarios">Scenarios</a></li><li class="active">Copy and transform stream</li></ol>
        </nav>
    </div>
    <!--main-->
    <div class="container">
        <div class="row">
            <!--left-->

            <div class="col-md-3" id="leftCol">

                <img src="http://jasperfx.github.io/marten/content/images/emblem.png" width="80%" align="middle" />
                <br />
                <ul class="nav nav-stacked affix" id="sidebar"></ul>
                <h3 class="no-margin">Next</h3><p><a href="/marten/documentation/scenarios/immutable_projections_readmodel">Immutable projections as read model</a></p>
                    <h3 class="no-margin">Previous</h3><a href="/marten/documentation/scenarios/aggregates_events_repositories">Aggregates, Events, Repositories</a></p>
                </ul>
            </div><!--/left-->
            <!--right-->
            <div class="col-md-9">
                <h1>Copy and transform stream <a href="https://github.com/jasperfx/marten/blob/master/documentation/documentation/scenarios/copyandtransformstream.md" class="text-muted small pull-right fa fa-github" style="margin-top: 10px"> Edit on GitHub</a></h1>

                <hr />
                <div id="main-pane">
                    <!--Title: Copy and transform stream-->
<p>This scenario demonstrates how to copy and transform event stream to enable</p>
<ul>
<li>Introduction of new events</li>
<li>Deletion of events</li>
</ul>
<h2 id="scenario">Scenario</h2>
<p>Lets say we have an event stream, from which we would like to delete events of specific kind. Furthermore, we have a new event type that we would like to compose from existing data (akin to versioning). In the sample below, we setup our initial stream.</p>
<pre><code class="language-csharp">&#xD;&#xA;&#x9;&#x9;&#x9;var started = new QuestStarted { Name = &quot;Find the Orb&quot; };&#xD;&#xA;&#x9;&#x9;&#x9;var joined = new MembersJoined { Day = 2, Location = &quot;Faldor&#x27;s Farm&quot;, Members = new[] { &quot;Garion&quot;, &quot;Polgara&quot;, &quot;Belgarath&quot; } };&#xD;&#xA;&#x9;&#x9;&#x9;var slayed1 = new MonsterSlayed { Name = &quot;Troll&quot; };&#xD;&#xA;&#x9;&#x9;&#x9;var slayed2 = new MonsterSlayed { Name = &quot;Dragon&quot; };&#xD;&#xA;&#x9;&#x9;&#x9;&#xD;&#xA;&#x9;&#x9;&#x9;using (var session = theStore.OpenSession())&#xD;&#xA;&#x9;&#x9;&#x9;{&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;session.Events.StartStream&lt;Quest&gt;(started.Name,started, joined, slayed1, slayed2);&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;session.SaveChanges();&#xD;&#xA;&#x9;&#x9;&#x9;}&#xD;&#xA;</code></pre>
<p>Next, we introduce a new event type to expand the <code>MembersJoined</code> to a series of events, one for each member.</p>
<pre><code class="language-csharp">&#xD;&#xA;&#x9;&#x9;public class MemberJoined&#xD;&#xA;&#x9;&#x9;{&#xD;&#xA;&#x9;&#x9;&#x9;public int Day { get; set; }&#xD;&#xA;&#x9;&#x9;&#x9;public string Location { get; set; }&#xD;&#xA;&#x9;&#x9;&#x9;public string Name { get; set; }&#xD;&#xA;&#xD;&#xA;&#x9;&#x9;&#x9;public MemberJoined()&#xD;&#xA;&#x9;&#x9;&#x9;{&#xD;&#xA;&#x9;&#x9;&#x9;}&#xD;&#xA;&#xD;&#xA;&#x9;&#x9;&#x9;public MemberJoined(int day, string location, string name)&#xD;&#xA;&#x9;&#x9;&#x9;{&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;Day = day;&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;Location = location;&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;Name = name;&#xD;&#xA;&#x9;&#x9;&#x9;}&#xD;&#xA;&#xD;&#xA;&#x9;&#x9;&#x9;public static MemberJoined[] From(MembersJoined @event)&#xD;&#xA;&#x9;&#x9;&#x9;{&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;return @event.Members.Select(x =&gt; new MemberJoined(@event.Day, @event.Location, x)).ToArray();&#xD;&#xA;&#x9;&#x9;&#x9;}&#xD;&#xA;&#x9;&#x9;}&#xD;&#xA;</code></pre>
<p>Lastly, we want trolls (<code>MonsterSlayed</code>) removed from our stream. However, the stream is a series of ordered, immutable data, with no functionality to patch or otherwise modify existing data. Instead of trying to mutate the stream, we can use the copy and transform pattern to introduce a new event stream. We do this by copying the existing stream to a new one, while applying any needed transforms to the event data being copied.</p>
<pre><code class="language-csharp">&#xD;&#xA;&#x9;&#x9;&#x9;using (var session = theStore.OpenSession())&#xD;&#xA;&#x9;&#x9;&#x9;{&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;var events = session.Events.FetchStream(started.Name);&#xD;&#xA;&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;var transformedEvents = events.SelectMany(x =&gt;&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;{&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;switch (x.Data)&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;{&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;case MonsterSlayed monster:&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;{&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;// Trolls we remove from our transformed stream&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;return monster.Name.Equals(&quot;Troll&quot;) ? new object[] { } : new[] { monster };&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;case MembersJoined members:&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;{&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;// MembersJoined events we transform into a series of events&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;return MemberJoined.From(members);&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xD;&#xA;&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;return new[] { x.Data };&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;}).Where(x =&gt; x != null).ToArray();&#xD;&#xA;&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;var moveTo = $&quot;{started.Name} without Trolls&quot;;&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;// We copy the transformed events to a new stream&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;session.Events.StartStream&lt;Quest&gt;(moveTo, transformedEvents);&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;// And additionally mark the old stream as moved. Furthermore, we assert on the new expected stream version to guard against any racing updates&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;session.Events.Append(started.Name, events.Count &#x2B; 1, new StreamMovedTo&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;{&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;To = moveTo&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;});&#xD;&#xA;&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;// Transactionally update the streams.&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;session.SaveChanges();&#xD;&#xA;&#x9;&#x9;&#x9;}&#xD;&#xA;</code></pre>
<p>As the new stream is produced, within the same transaction we introduce an event dictating the stream being copied to have been moved. This should serve as an indication to no longer append new events into the stream. Furthermore, it ensures that the underlying stream being copied has not changed during the copy &amp; transform process (as we assert on the expected stream version).</p>
<pre><code class="language-csharp">&#xD;&#xA;&#x9;&#x9;public class StreamMovedTo&#xD;&#xA;&#x9;&#x9;{&#xD;&#xA;&#x9;&#x9;&#x9;public string To { get; set; }&#xD;&#xA;&#x9;&#x9;}&#xD;&#xA;</code></pre>

                </div>
                <hr />
                <nav class="related-links">
                    <span>
                        <strong>Previous: </strong><a href="/marten/documentation/scenarios/aggregates_events_repositories">Aggregates, Events, Repositories</a>
                    </span>
                    <span class="pull-right">
                        <strong>Next: </strong><a href="/marten/documentation/scenarios/immutable_projections_readmodel">Immutable projections as read model</a>
                    </span>
                </nav>
            </div><!--/right-->
        </div><!--/row-->
    </div><!--/container-->
</body>

<foot>
    <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type='text/javascript' src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/marten/content/prism.js"></script>
    <script type="text/javascript" src="/marten/content/sidebar.js"></script>
    <script type="text/javascript" src="/marten/content/affix.js"></script>

    <script>
        $('#search').keyup(function (e) {
            if (e.keyCode == 13) {
                var search = $('#search').val();

                var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
                url = encodeURI(url);

                //alert(url);

                window.location.href = url;

                e.stopPropagation();
                if (e.cancelBubble != null) e.cancelBubble = true;
                return false;
            }

        });
    </script>
</foot>
</html>
