<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Marten - Schema Feature Extensions</title>
    <link href="/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="/content/prism.css" rel="stylesheet" type="text/css" />
    <link href="/content/theme.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />

    <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

    <!-- CSS code from Bootply.com editor -->
    <link href="/content/affix.css" rel="stylesheet" type="text/css" />
</head>

<!-- HTML code from Bootply.com editor -->

<body>
    <a href="https://github.com/jasperfx/marten"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

    <nav class="navbar navbar-default navbar-fixed-top" role="banner">
        <div class="container">
            <div class="navbar-header">
                <a href="/" class="navbar-brand">Marten 3.13.1</a>
            </div>
            <nav class="collapse navbar-collapse" role="navigation">
                <ul class="nav navbar-nav pull-right">
                    <li>
                        <a href="/getting_started">Getting Started</a>
                    </li>
                    <li>
                        <a href="/documentation">Documentation</a>
                    </li>
                    <li>
                        <a href="/migration_guide">Migration Guide</a>
                    </li>
                    <li>
                        <a href="https://gitter.im/jasperfx/marten?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/marten" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/marten_lib?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @marten_lib</a>
                        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    </li>
                    <li><a href="/documentation/documents/advanced/retrypolicy" title="Retry Policies">Previous</a></li>
                <li><a href="/documentation/documents/advanced/soft_deletes" title="Soft Deletes">Next</a></li>
                </ul>
                <div class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <input id="search" type="search" class="form-control" placeholder="Search">
                    </div>
                </div>
            </nav>
        </div>
    </nav>
    <div class="container">
        <nav class="navbar-inverse">
            <ol class="breadcrumb"><li><a href="/">Marten</a></li><li><a href="/documentation">Documentation</a></li><li><a href="/documentation/documents">Marten as Document Db</a></li><li><a href="/documentation/documents/advanced">Advanced Topics</a></li><li class="active">Schema Feature Extensions</li></ol>
        </nav>
    </div>
    <!--main-->
    <div class="container">
        <div class="row">
            <!--left-->

            <div class="col-md-3" id="leftCol">

                <img src="/content/images/emblem.png" width="80%" align="middle" />
                <br />
                <ul class="nav nav-stacked affix" id="sidebar"></ul>
                <h3 class="no-margin">Next</h3><p><a href="/documentation/documents/advanced/soft_deletes">Soft Deletes</a></p>
                    <h3 class="no-margin">Previous</h3><a href="/documentation/documents/advanced/retrypolicy">Retry Policies</a></p>
                </ul>
            </div><!--/left-->
            <!--right-->
            <div class="col-md-9">
                <h1>Schema Feature Extensions <a href="https://github.com/jasperfx/marten/blob/master/documentation/documentation/documents/advanced/extensions.md" class="text-muted small pull-right fa fa-github" style="margin-top: 10px"> Edit on GitHub</a></h1>

                <hr />
                <div id="main-pane">
                    <!--title:Schema Feature Extensions-->
<p>New in Marten 2.4.0 is the ability to add additional features with custom database schema objects that simply plug into Marten's
<a href="/documentation/schema/migrations">schema management facilities</a>. The key abstraction is the <code>IFeatureSchema</code> interface shown below:</p>
<pre><code class="language-csharp">&#xD;&#xA;public interface IFeatureSchema&#xD;&#xA;{&#xD;&#xA;    IEnumerable&lt;Type&gt; DependentTypes();&#xD;&#xA;&#xD;&#xA;    bool IsActive(StoreOptions options);&#xD;&#xA;&#xD;&#xA;    ISchemaObject[] Objects { get; }&#xD;&#xA;&#xD;&#xA;    Type StorageType { get; }&#xD;&#xA;&#xD;&#xA;    string Identifier { get; }&#xD;&#xA;&#xD;&#xA;    void WritePermissions(DdlRules rules, StringWriter writer);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;</code></pre>
<p>Not to worry though, Marten comes with a base class that makes it a bit simpler to build out new features. Here's a very simple
example that defines a custom table with one column:</p>
<pre><code class="language-csharp">&#xD;&#xA;public class FakeStorage : FeatureSchemaBase&#xD;&#xA;{&#xD;&#xA;    public FakeStorage(StoreOptions options) : base(&quot;fake&quot;, options)&#xD;&#xA;    {&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    protected override IEnumerable&lt;ISchemaObject&gt; schemaObjects()&#xD;&#xA;    {&#xD;&#xA;        var table = new Table(new DbObjectName(Options.DatabaseSchemaName, &quot;mt_fake_table&quot;));&#xD;&#xA;        table.AddColumn(&quot;name&quot;, &quot;varchar&quot;);&#xD;&#xA;&#xD;&#xA;        yield return table;&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;</code></pre>
<p>Now, to actually apply this feature to your Marten applications, use this syntax:</p>
<pre><code class="language-csharp">&#xD;&#xA;var store = DocumentStore.For(_ =&gt;&#xD;&#xA;{&#xD;&#xA;    // Creates a new instance of FakeStorage and&#xD;&#xA;    // passes along the current StoreOptions&#xD;&#xA;    _.Storage.Add&lt;FakeStorage&gt;();&#xD;&#xA;&#xD;&#xA;    // or&#xD;&#xA;&#xD;&#xA;    _.Storage.Add(new FakeStorage(_));&#xD;&#xA;});&#xD;&#xA;</code></pre>
<p>Do note that when you use the <code>Add&lt;T&gt;()</code> syntax, Marten will pass along the current <code>StoreOptions</code> to the constructor function if there is a constructor with that signature. Otherwise, it uses the no-arg constructor.</p>
<p>While you <em>can</em> directly implement the <code>ISchemaObject</code> interface for something Marten doesn't already support, it's probably far easier to just configure one of the existing implementations shown in the following sections.</p>
<ul>
<li><code>Table</code></li>
<li><code>Function</code></li>
<li><code>Sequence</code></li>
</ul>
<h2 id="table">Table</h2>
<p>Postgresql tables can be modeled with the <code>Table</code> class as shown in this example from the event store inside of Marten:</p>
<pre><code class="language-csharp">&#xD;&#xA;public class EventsTable: Table&#xD;&#xA;{&#xD;&#xA;    public EventsTable(EventGraph events) : base(new DbObjectName(events.DatabaseSchemaName, &quot;mt_events&quot;))&#xD;&#xA;    {&#xD;&#xA;        var stringIdType = events.GetStreamIdDBType();&#xD;&#xA;&#xD;&#xA;        AddPrimaryKey(new TableColumn(&quot;seq_id&quot;, &quot;bigint&quot;));&#xD;&#xA;        AddColumn(&quot;id&quot;, &quot;uuid&quot;, &quot;NOT NULL&quot;);&#xD;&#xA;        AddColumn(&quot;stream_id&quot;, stringIdType, (events.TenancyStyle != TenancyStyle.Conjoined) ? $&quot;REFERENCES {events.DatabaseSchemaName}.mt_streams ON DELETE CASCADE&quot; : null);&#xD;&#xA;        AddColumn(&quot;version&quot;, &quot;integer&quot;, &quot;NOT NULL&quot;);&#xD;&#xA;        AddColumn(&quot;data&quot;, &quot;jsonb&quot;, &quot;NOT NULL&quot;);&#xD;&#xA;        AddColumn(&quot;type&quot;, &quot;varchar(500)&quot;, &quot;NOT NULL&quot;);&#xD;&#xA;        AddColumn(&quot;timestamp&quot;, &quot;timestamptz&quot;, &quot;default (now()) NOT NULL&quot;);&#xD;&#xA;        AddColumn&lt;TenantIdColumn&gt;();&#xD;&#xA;        AddColumn(new DotNetTypeColumn { Directive = &quot;NULL&quot; });&#xD;&#xA;&#xD;&#xA;        if (events.TenancyStyle == TenancyStyle.Conjoined)&#xD;&#xA;        {&#xD;&#xA;            Constraints.Add($&quot;FOREIGN KEY(stream_id, {TenantIdColumn.Name}) REFERENCES {events.DatabaseSchemaName}.mt_streams(id, {TenantIdColumn.Name})&quot;);&#xD;&#xA;            Constraints.Add($&quot;CONSTRAINT pk_mt_events_stream_and_version UNIQUE(stream_id, {TenantIdColumn.Name}, version)&quot;);&#xD;&#xA;        }&#xD;&#xA;        else&#xD;&#xA;        {&#xD;&#xA;            Constraints.Add(&quot;CONSTRAINT pk_mt_events_stream_and_version UNIQUE(stream_id, version)&quot;);&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;        Constraints.Add(&quot;CONSTRAINT pk_mt_events_id_unique UNIQUE(id)&quot;);&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;</code></pre>
<h2 id="function">Function</h2>
<p>Postgresql functions can be managed by creating a subclass of the <code>Function</code> base class as shown below from the big &quot;append event&quot; function in the event store:</p>
<pre><code class="language-csharp">&#xD;&#xA;    public class AppendEventFunction: Function&#xD;&#xA;    {&#xD;&#xA;        private readonly EventGraph _events;&#xD;&#xA;&#xD;&#xA;        public AppendEventFunction(EventGraph events) : base(new DbObjectName(events.DatabaseSchemaName, &quot;mt_append_event&quot;))&#xD;&#xA;        {&#xD;&#xA;            _events = events;&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;        public override void Write(DdlRules rules, StringWriter writer)&#xD;&#xA;        {&#xD;&#xA;            var streamIdType = _events.GetStreamIdDBType();&#xD;&#xA;            var databaseSchema = _events.DatabaseSchemaName;&#xD;&#xA;&#xD;&#xA;            var tenancyStyle = _events.TenancyStyle;&#xD;&#xA;&#xD;&#xA;            var streamsWhere = &quot;id = stream&quot;;&#xD;&#xA;&#xD;&#xA;            if (tenancyStyle == TenancyStyle.Conjoined)&#xD;&#xA;            {&#xD;&#xA;                streamsWhere &#x2B;= &quot; AND tenant_id = tenantid&quot;;&#xD;&#xA;            }&#xD;&#xA;&#xD;&#xA;            writer.WriteLine($@&quot;&#xD;&#xA;CREATE OR REPLACE FUNCTION {Identifier}(stream {streamIdType}, stream_type varchar, tenantid varchar, event_ids uuid[], event_types varchar[], dotnet_types varchar[], bodies jsonb[]) RETURNS int[] AS $$&#xD;&#xA;DECLARE&#xD;&#xA;&#x9;event_version int;&#xD;&#xA;&#x9;event_type varchar;&#xD;&#xA;&#x9;event_id uuid;&#xD;&#xA;&#x9;body jsonb;&#xD;&#xA;&#x9;index int;&#xD;&#xA;&#x9;seq int;&#xD;&#xA;    actual_tenant varchar;&#xD;&#xA;&#x9;return_value int[];&#xD;&#xA;BEGIN&#xD;&#xA;&#x9;select version into event_version from {databaseSchema}.mt_streams where {streamsWhere}{(_events.UseAppendEventForUpdateLock ? &quot; for update&quot; : string.Empty)};&#xD;&#xA;&#x9;if event_version IS NULL then&#xD;&#xA;&#x9;&#x9;event_version = 0;&#xD;&#xA;&#x9;&#x9;insert into {databaseSchema}.mt_streams (id, type, version, timestamp, tenant_id) values (stream, stream_type, 0, now(), tenantid);&#xD;&#xA;    else&#xD;&#xA;        if tenantid IS NOT NULL then&#xD;&#xA;            select tenant_id into actual_tenant from {databaseSchema}.mt_streams where {streamsWhere};&#xD;&#xA;            if actual_tenant != tenantid then&#xD;&#xA;                RAISE EXCEPTION &#x27;Marten: The tenantid does not match the existing stream&#x27;;&#xD;&#xA;            end if;&#xD;&#xA;        end if;&#xD;&#xA;&#x9;end if;&#xD;&#xA;&#xD;&#xA;&#x9;index := 1;&#xD;&#xA;&#x9;return_value := ARRAY[event_version &#x2B; array_length(event_ids, 1)];&#xD;&#xA;&#xD;&#xA;&#x9;foreach event_id in ARRAY event_ids&#xD;&#xA;&#x9;loop&#xD;&#xA;&#x9;    seq := nextval(&#x27;{databaseSchema}.mt_events_sequence&#x27;);&#xD;&#xA;&#x9;&#x9;return_value := array_append(return_value, seq);&#xD;&#xA;&#xD;&#xA;&#x9;    event_version := event_version &#x2B; 1;&#xD;&#xA;&#x9;&#x9;event_type = event_types[index];&#xD;&#xA;&#x9;&#x9;body = bodies[index];&#xD;&#xA;&#xD;&#xA;&#x9;&#x9;insert into {databaseSchema}.mt_events&#xD;&#xA;&#x9;&#x9;&#x9;(seq_id, id, stream_id, version, data, type, tenant_id, {DocumentMapping.DotNetTypeColumn})&#xD;&#xA;&#x9;&#x9;values&#xD;&#xA;&#x9;&#x9;&#x9;(seq, event_id, stream, event_version, body, event_type, tenantid, dotnet_types[index]);&#xD;&#xA;&#xD;&#xA;&#x9;&#x9;index := index &#x2B; 1;&#xD;&#xA;&#x9;end loop;&#xD;&#xA;&#xD;&#xA;&#x9;update {databaseSchema}.mt_streams set version = event_version, timestamp = now() where {streamsWhere};&#xD;&#xA;&#xD;&#xA;&#x9;return return_value;&#xD;&#xA;END&#xD;&#xA;$$ LANGUAGE plpgsql;&#xD;&#xA;&quot;);&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;        protected override string toDropSql()&#xD;&#xA;        {&#xD;&#xA;            var streamIdType = _events.GetStreamIdDBType();&#xD;&#xA;            return $&quot;drop function if exists {Identifier} ({streamIdType}, varchar, varchar, uuid[], varchar[], jsonb[]);&quot;;&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;</code></pre>
<h2 id="sequence">Sequence</h2>
<p><a href="https://www.postgresql.org/docs/10/static/sql-createsequence.html">Postgresql sequences</a> can be managed with this usage:</p>
<pre><code class="language-csharp">&#xD;&#xA;var sequence = new Sequence(new DbObjectName(DatabaseSchemaName, &quot;mt_events_sequence&quot;))&#xD;&#xA;{&#xD;&#xA;    Owner = eventsTable.Identifier,&#xD;&#xA;    OwnerColumn = &quot;seq_id&quot;&#xD;&#xA;};&#xD;&#xA;</code></pre>

                </div>
                <hr />
                <nav class="related-links">
                    <span>
                        <strong>Previous: </strong><a href="/documentation/documents/advanced/retrypolicy">Retry Policies</a>
                    </span>
                    <span class="pull-right">
                        <strong>Next: </strong><a href="/documentation/documents/advanced/soft_deletes">Soft Deletes</a>
                    </span>
                </nav>
            </div><!--/right-->
        </div><!--/row-->
    </div><!--/container-->
    <footer>
        <ul>
            <li>
                <a href="https://dotnetfoundation.org">
                    <img class="dot-net-foundation-logo" src="https://raw.githubusercontent.com/dotnet/swag/master/logo/dotnetfoundation_v4.png" alt="Supported by the .NET Foundation" />
                </a>
                Supported by the <a href="https://dotnetfoundation.org">.NET Foundation</a>
            </li>
        </ul>
    </footer>
</body>

<foot>
    <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type='text/javascript' src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/content/prism.js"></script>
    <script type="text/javascript" src="/content/sidebar.js"></script>
    <script type="text/javascript" src="/content/affix.js"></script>

    <script>
        $('#search').keyup(function (e) {
            if (e.keyCode == 13) {
                var search = $('#search').val();

                var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
                url = encodeURI(url);

                //alert(url);

                window.location.href = url;

                e.stopPropagation();
                if (e.cancelBubble != null) e.cancelBubble = true;
                return false;
            }

        });
    </script>
</foot>
</html>
