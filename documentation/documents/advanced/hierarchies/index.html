<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Marten - Document Hierarchies</title>
    <link href="/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="/content/prism.css" rel="stylesheet" type="text/css" />
    <link href="/content/theme.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />

    <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

    <!-- CSS code from Bootply.com editor -->
    <link href="/content/affix.css" rel="stylesheet" type="text/css" />
</head>

<!-- HTML code from Bootply.com editor -->

<body>
    <a href="https://github.com/jasperfx/marten"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

    <nav class="navbar navbar-default navbar-fixed-top" role="banner">
        <div class="container">
            <div class="navbar-header">
                <a href="/" class="navbar-brand">Marten 3.12.2</a>
            </div>
            <nav class="collapse navbar-collapse" role="navigation">
                <ul class="nav navbar-nav pull-right">
                    <li>
                        <a href="/getting_started">Getting Started</a>
                    </li>
                    <li>
                        <a href="/documentation">Documentation</a>
                    </li>
                    <li>
                        <a href="/migration_guide">Migration Guide</a>
                    </li>
                    <li>
                        <a href="https://gitter.im/jasperfx/marten?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/marten" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/marten_lib?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @marten_lib</a>
                        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    </li>
                    <li><a href="/documentation/documents/advanced" title="Advanced Topics">Previous</a></li>
                <li><a href="/documentation/documents/advanced/eject" title="Ejecting Documents from a Session">Next</a></li>
                </ul>
                <div class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <input id="search" type="search" class="form-control" placeholder="Search">
                    </div>
                </div>
            </nav>
        </div>
    </nav>
    <div class="container">
        <nav class="navbar-inverse">
            <ol class="breadcrumb"><li><a href="/">Marten</a></li><li><a href="/documentation">Documentation</a></li><li><a href="/documentation/documents">Marten as Document Db</a></li><li><a href="/documentation/documents/advanced">Advanced Topics</a></li><li class="active">Document Hierarchies</li></ol>
        </nav>
    </div>
    <!--main-->
    <div class="container">
        <div class="row">
            <!--left-->

            <div class="col-md-3" id="leftCol">

                <img src="/content/images/emblem.png" width="80%" align="middle" />
                <br />
                <ul class="nav nav-stacked affix" id="sidebar"></ul>
                <h3 class="no-margin">Next</h3><p><a href="/documentation/documents/advanced/eject">Ejecting Documents from a Session</a></p>
                    <h3 class="no-margin">Previous</h3><a href="/documentation/documents/advanced">Advanced Topics</a></p>
                </ul>
            </div><!--/left-->
            <!--right-->
            <div class="col-md-9">
                <h1>Document Hierarchies <a href="https://github.com/jasperfx/marten/blob/master/documentation/documentation/documents/advanced/hierarchies.md" class="text-muted small pull-right fa fa-github" style="margin-top: 10px"> Edit on GitHub</a></h1>

                <hr />
                <div id="main-pane">
                    <!--Title:Document Hierarchies-->
<!--Url:hierarchies-->
<p>Marten now allows you to specify that hierarchies of document types should be stored in one table and allow you
to query for either the base class or any of the subclasses.</p>
<h2 id="one-level-hierarchies">One Level Hierarchies</h2>
<p>To make that concrete, let's say you have a document type named <code>User</code> that has a pair of specialized subclasses
called <code>SuperUser</code> and <code>AdminUser</code>. To use the document hierarchy storage, we need to tell Marten that
<code>SuperUser</code> and <code>AdminUser</code> should just be stored as subclasses of <code>User</code> like this:</p>
<pre><code class="language-csharp">&#xD;&#xA;var store = DocumentStore.For(_ =&gt;&#xD;&#xA;{&#xD;&#xA;    _.Connection(&quot;connection to your database&quot;);&#xD;&#xA;&#xD;&#xA;    _.Schema.For&lt;User&gt;()&#xD;&#xA;        // generic version&#xD;&#xA;        .AddSubClass&lt;AdminUser&gt;()&#xD;&#xA;&#xD;&#xA;        // By document type object&#xD;&#xA;        .AddSubClass(typeof (SuperUser));&#xD;&#xA;});&#xD;&#xA;&#xD;&#xA;using (var session = store.QuerySession())&#xD;&#xA;{&#xD;&#xA;    // query for all types of User and User itself&#xD;&#xA;    session.Query&lt;User&gt;().ToList();&#xD;&#xA;&#xD;&#xA;    // query for only SuperUser&#xD;&#xA;    session.Query&lt;SuperUser&gt;().ToList();&#xD;&#xA;}&#xD;&#xA;</code></pre>
<p>With the configuration above, you can now query by <code>User</code> and get <code>AdminUser</code> and <code>SuperUser</code> documents as part of the results,
or query directly for any of the subclasses to limit the query.</p>
<p>The best description of what is possible with hierarchical storage is to read the <a href="https://github.com/JasperFx/marten/blob/master/src/Marten.Testing/Services/BatchedQuerying/batched_querying_acceptance_Tests.cs">acceptance tests for this feature</a>.</p>
<p>There's a couple things to be aware of with type hierarchies:</p>
<ul>
<li>A document type that is either abstract or an interface is automatically assumed to be a hierarchy</li>
<li>If you want to use a concrete type as the base class for a hierarchy, you will need to explicitly configure
that by adding the subclasses as shown above</li>
<li>At this point, you can only specify &quot;Searchable&quot; fields on the top, base type</li>
<li>The subclass document types must be convertable to the top level type. As of right now, Marten does not support &quot;structural typing&quot;,
but may in the future</li>
<li>Internally, the subclass type documents are also stored as the parent type in the Identity Map mechanics. Many, many hours of
banging my head on my desk were required to add this feature.</li>
</ul>
<h2 id="multi-level-hierarchies">Multi Level Hierarchies</h2>
<p>Say you have a document type named <code>ISmurf</code> that is implemented by <code>Smurf</code>. Now, say the latter has a pair of specialized
subclasses called <code>PapaSmurf</code> and <code>PapySmurf</code> and that both implement <code>IPapaSmurf</code> and that <code>PapaSmurf</code> has the subclass
<code>BrainySmurf</code> like so:</p>
<pre><code class="language-csharp">&#xD;&#xA;public interface ISmurf&#xD;&#xA;{&#xD;&#xA;    string Ability { get; set; }&#xD;&#xA;    Guid Id { get; set; }&#xD;&#xA;}&#xD;&#xA;public class Smurf : ISmurf&#xD;&#xA;{&#xD;&#xA;    public string Ability { get; set; }&#xD;&#xA;    public Guid Id { get; set; }&#xD;&#xA;}&#xD;&#xA;public interface IPapaSmurf : ISmurf{}&#xD;&#xA;public class PapaSmurf : Smurf, IPapaSmurf{}&#xD;&#xA;public class PapySmurf : Smurf, IPapaSmurf{}&#xD;&#xA;public class BrainySmurf : PapaSmurf{ }&#xD;&#xA;</code></pre>
<p>If you wish to query over one of hierarchy classes and be able to get all of its documents as well as its subclasses,
first you will need to map the hierarchy like so:</p>
<pre><code class="language-csharp">&#xD;&#xA;public query_with_inheritance(DefaultStoreFixture fixture) : base(fixture)&#xD;&#xA;{&#xD;&#xA;    StoreOptions(_ =&gt;&#xD;&#xA;    {&#xD;&#xA;        _.Schema.For&lt;ISmurf&gt;()&#xD;&#xA;            .AddSubClassHierarchy(typeof(Smurf), typeof(PapaSmurf), typeof(PapySmurf), typeof(IPapaSmurf), typeof(BrainySmurf));&#xD;&#xA;&#xD;&#xA;        // Alternatively, you can use the following:&#xD;&#xA;        // _.Schema.For&lt;ISmurf&gt;().AddSubClassHierarchy();&#xD;&#xA;        // this, however, will use the assembly&#xD;&#xA;        // of type ISmurf to get all its&#x27; subclasses/implementations.&#xD;&#xA;        // In projects with many types, this approach will be undvisable.&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        _.Connection(ConnectionSource.ConnectionString);&#xD;&#xA;        _.AutoCreateSchemaObjects = AutoCreate.All;&#xD;&#xA;&#xD;&#xA;        _.Schema.For&lt;ISmurf&gt;().GinIndexJsonData();&#xD;&#xA;    });&#xD;&#xA;}&#xD;&#xA;</code></pre>
<p>Note that if you wish to use aliases on certain subclasses, you could pass a <code>MappedType</code>, which contains the type to map
and its alias. Since <code>Type</code> implicitly converts to <code>MappedType</code> and the methods takes in <code>params MappedType[]</code>, you could
use a mix of both like so:</p>
<pre><code class="language-csharp">&#xD;&#xA;_.Schema.For&lt;ISmurf&gt;()&#xD;&#xA;    .AddSubClassHierarchy(&#xD;&#xA;        typeof(Smurf),&#xD;&#xA;        new MappedType(typeof(PapaSmurf), &quot;papa&quot;),&#xD;&#xA;        typeof(PapySmurf),&#xD;&#xA;        typeof(IPapaSmurf),&#xD;&#xA;        typeof(BrainySmurf)&#xD;&#xA;    );&#xD;&#xA;</code></pre>
<p>Now you can query the &quot;complex&quot; hierarchy in the following ways:</p>
<pre><code class="language-csharp">&#xD;&#xA;[Fact]&#xD;&#xA;public void get_all_subclasses_of_a_subclass()&#xD;&#xA;{&#xD;&#xA;    var smurf = new Smurf {Ability = &quot;Follow the herd&quot;};&#xD;&#xA;    var papa = new PapaSmurf {Ability = &quot;Lead&quot;};&#xD;&#xA;    var brainy = new BrainySmurf{Ability = &quot;Invent&quot;};&#xD;&#xA;    theSession.Store(smurf,papa,brainy);&#xD;&#xA;&#xD;&#xA;    theSession.SaveChanges();&#xD;&#xA;&#xD;&#xA;    theSession.Query&lt;Smurf&gt;().Count().ShouldBe(3);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;[Fact]&#xD;&#xA;public void get_all_subclasses_of_a_subclass2()&#xD;&#xA;{&#xD;&#xA;    var smurf = new Smurf {Ability = &quot;Follow the herd&quot;};&#xD;&#xA;    var papa = new PapaSmurf {Ability = &quot;Lead&quot;};&#xD;&#xA;    var brainy = new BrainySmurf{Ability = &quot;Invent&quot;};&#xD;&#xA;    theSession.Store(smurf,papa,brainy);&#xD;&#xA;&#xD;&#xA;    theSession.SaveChanges();&#xD;&#xA;&#xD;&#xA;    theSession.Query&lt;PapaSmurf&gt;().Count().ShouldBe(2);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;[Fact]&#xD;&#xA;public void get_all_subclasses_of_a_subclass_with_where()&#xD;&#xA;{&#xD;&#xA;    var smurf = new Smurf {Ability = &quot;Follow the herd&quot;};&#xD;&#xA;    var papa = new PapaSmurf {Ability = &quot;Lead&quot;};&#xD;&#xA;    var brainy = new BrainySmurf{Ability = &quot;Invent&quot;};&#xD;&#xA;    theSession.Store(smurf,papa,brainy);&#xD;&#xA;&#xD;&#xA;    theSession.SaveChanges();&#xD;&#xA;&#xD;&#xA;    theSession.Query&lt;PapaSmurf&gt;().Count(s=&gt;s.Ability == &quot;Invent&quot;).ShouldBe(1);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;[Fact]&#xD;&#xA;public void get_all_subclasses_of_a_subclass_with_where_with_camel_casing()&#xD;&#xA;{&#xD;&#xA;    StoreOptions(_ =&gt;&#xD;&#xA;    {&#xD;&#xA;        _.Schema.For&lt;ISmurf&gt;()&#xD;&#xA;            .AddSubClassHierarchy(typeof(Smurf), typeof(PapaSmurf), typeof(PapySmurf), typeof(IPapaSmurf), typeof(BrainySmurf));&#xD;&#xA;&#xD;&#xA;        // Alternatively, you can use the following:&#xD;&#xA;        // _.Schema.For&lt;ISmurf&gt;().AddSubClassHierarchy();&#xD;&#xA;        // this, however, will use the assembly&#xD;&#xA;        // of type ISmurf to get all its&#x27; subclasses/implementations.&#xD;&#xA;        // In projects with many types, this approach will be undvisable.&#xD;&#xA;&#xD;&#xA;        _.UseDefaultSerialization(EnumStorage.AsString, Casing.CamelCase);&#xD;&#xA;&#xD;&#xA;        _.Connection(ConnectionSource.ConnectionString);&#xD;&#xA;        _.AutoCreateSchemaObjects = AutoCreate.All;&#xD;&#xA;&#xD;&#xA;        _.Schema.For&lt;ISmurf&gt;().GinIndexJsonData();&#xD;&#xA;    });&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    var smurf = new Smurf { Ability = &quot;Follow the herd&quot; };&#xD;&#xA;    var papa = new PapaSmurf { Ability = &quot;Lead&quot; };&#xD;&#xA;    var brainy = new BrainySmurf { Ability = &quot;Invent&quot; };&#xD;&#xA;    theSession.Store(smurf, papa, brainy);&#xD;&#xA;&#xD;&#xA;    theSession.SaveChanges();&#xD;&#xA;&#xD;&#xA;    theSession.Query&lt;PapaSmurf&gt;().Count(s =&gt; s.Ability == &quot;Invent&quot;).ShouldBe(1);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;[Fact]&#xD;&#xA;public void get_all_subclasses_of_an_interface()&#xD;&#xA;{&#xD;&#xA;    var smurf = new Smurf { Ability = &quot;Follow the herd&quot; };&#xD;&#xA;    var papa = new PapaSmurf { Ability = &quot;Lead&quot; };&#xD;&#xA;    var papy = new PapySmurf { Ability = &quot;Lead&quot; };&#xD;&#xA;    var brainy = new BrainySmurf { Ability = &quot;Invent&quot; };&#xD;&#xA;    theSession.Store(smurf, papa, brainy, papy);&#xD;&#xA;&#xD;&#xA;    theSession.SaveChanges();&#xD;&#xA;&#xD;&#xA;    theSession.Query&lt;IPapaSmurf&gt;().Count().ShouldBe(3);&#xD;&#xA;}&#xD;&#xA;</code></pre>

                </div>
                <hr />
                <nav class="related-links">
                    <span>
                        <strong>Previous: </strong><a href="/documentation/documents/advanced">Advanced Topics</a>
                    </span>
                    <span class="pull-right">
                        <strong>Next: </strong><a href="/documentation/documents/advanced/eject">Ejecting Documents from a Session</a>
                    </span>
                </nav>
            </div><!--/right-->
        </div><!--/row-->
    </div><!--/container-->
    <footer>
        <ul>
            <li>
                <a href="https://dotnetfoundation.org">
                    <img class="dot-net-foundation-logo" src="https://raw.githubusercontent.com/dotnet/swag/master/logo/dotnetfoundation_v4.png" alt="Supported by the .NET Foundation" />
                </a>
                Supported by the <a href="https://dotnetfoundation.org">.NET Foundation</a>
            </li>
        </ul>
    </footer>
</body>

<foot>
    <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type='text/javascript' src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/content/prism.js"></script>
    <script type="text/javascript" src="/content/sidebar.js"></script>
    <script type="text/javascript" src="/content/affix.js"></script>

    <script>
        $('#search').keyup(function (e) {
            if (e.keyCode == 13) {
                var search = $('#search').val();

                var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
                url = encodeURI(url);

                //alert(url);

                window.location.href = url;

                e.stopPropagation();
                if (e.cancelBubble != null) e.cancelBubble = true;
                return false;
            }

        });
    </script>
</foot>
</html>
