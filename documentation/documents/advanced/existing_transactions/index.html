<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Marten - Enlisting in Existing Transactions</title>
    <link href="/marten/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="/marten/content/prism.css" rel="stylesheet" type="text/css" />
    <link href="/marten/content/theme.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />

    <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

    <!-- CSS code from Bootply.com editor -->
    <link href="/marten/content/affix.css" rel="stylesheet" type="text/css" />
</head>

<!-- HTML code from Bootply.com editor -->

<body>
    <a href="https://github.com/jasperfx/marten"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

    <nav class="navbar navbar-default navbar-fixed-top" role="banner">
        <div class="container">
            <div class="navbar-header">
                <a href="/marten" class="navbar-brand">Marten 3.12.0</a>
            </div>
            <nav class="collapse navbar-collapse" role="navigation">
                <ul class="nav navbar-nav pull-right">
                    <li>
                        <a href="/marten/getting_started">Getting Started</a>
                    </li>
                    <li>
                        <a href="/marten/documentation">Documentation</a>
                    </li>
                    <li>
                        <a href="/marten/migration_guide">Migration Guide</a>
                    </li>
                    <li>
                        <a href="https://gitter.im/jasperfx/marten?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/marten" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/marten_lib?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @marten_lib</a>
                        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    </li>
                    <li><a href="/marten/documentation/documents/advanced/eject" title="Ejecting Documents from a Session">Previous</a></li>
                <li><a href="/marten/documentation/documents/advanced/customizing_linq" title="Extending Marten's Linq Support">Next</a></li>
                </ul>
                <div class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <input id="search" type="search" class="form-control" placeholder="Search">
                    </div>
                </div>
            </nav>
        </div>
    </nav>
    <div class="container">
        <nav class="navbar-inverse">
            <ol class="breadcrumb"><li><a href="/marten/">Marten</a></li><li><a href="/marten/documentation">Documentation</a></li><li><a href="/marten/documentation/documents">Marten as Document Db</a></li><li><a href="/marten/documentation/documents/advanced">Advanced Topics</a></li><li class="active">Enlisting in Existing Transactions</li></ol>
        </nav>
    </div>
    <!--main-->
    <div class="container">
        <div class="row">
            <!--left-->

            <div class="col-md-3" id="leftCol">

                <img src="/content/images/emblem.png" width="80%" align="middle" />
                <br />
                <ul class="nav nav-stacked affix" id="sidebar"></ul>
                <h3 class="no-margin">Next</h3><p><a href="/marten/documentation/documents/advanced/customizing_linq">Extending Marten's Linq Support</a></p>
                    <h3 class="no-margin">Previous</h3><a href="/marten/documentation/documents/advanced/eject">Ejecting Documents from a Session</a></p>
                </ul>
            </div><!--/left-->
            <!--right-->
            <div class="col-md-9">
                <h1>Enlisting in Existing Transactions <a href="https://github.com/jasperfx/marten/blob/master/documentation/documentation/documents/advanced/existing_transactions.md" class="text-muted small pull-right fa fa-github" style="margin-top: 10px"> Edit on GitHub</a></h1>

                <hr />
                <div id="main-pane">
                    <!--title:Enlisting in Existing Transactions-->
<p>Before Marten 2.4.0, a Marten <code>IDocumentSession</code> always controlled the lifecycle of its underlying database
connection and transaction boundaries. With the 2.4.0+ release, you can pass in an existing transaction or connection, direct
Marten to enlist in an ambient transaction scope, and even direct Marten on whether or not it owns the transaction boundaries
to override whether or not <code>SaveChanges/SaveChangesAsync</code> will commit the underlying transaction.</p>
<p>Do note that the transaction scope enlisting is only available in either the full .Net framework (&gt; .Net 4.6) or applications targeting
Netstandard 2.0.</p>
<pre><code class="language-csharp">&#xD;&#xA;public void samples(IDocumentStore store, NpgsqlConnection connection, NpgsqlTransaction transaction)&#xD;&#xA;{&#xD;&#xA;    // Use an existing connection, but Marten still controls the transaction lifecycle&#xD;&#xA;    var session1 = store.OpenSession(new SessionOptions&#xD;&#xA;    {&#xD;&#xA;        Connection = connection&#xD;&#xA;    });&#xD;&#xA;&#xD;&#xA;    // Enlist in an existing Npgsql transaction, but&#xD;&#xA;    // choose not to allow the session to own the transaction&#xD;&#xA;    // boundaries&#xD;&#xA;    var session2 = store.OpenSession(new SessionOptions&#xD;&#xA;    {&#xD;&#xA;        Transaction = transaction,&#xD;&#xA;        OwnsTransactionLifecycle = false&#xD;&#xA;    });&#xD;&#xA;&#xD;&#xA;    // This is syntactical sugar for the sample above&#xD;&#xA;    var session3 = store.OpenSession(SessionOptions.ForTransaction(transaction));&#xD;&#xA;&#xD;&#xA;    // Enlist in the current, ambient transaction scope&#xD;&#xA;    using (var scope = new TransactionScope())&#xD;&#xA;    {&#xD;&#xA;        var session4 = store.OpenSession(SessionOptions.ForCurrentTransaction());&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    // or this is the long hand way of doing the options above&#xD;&#xA;    using (var scope = new TransactionScope())&#xD;&#xA;    {&#xD;&#xA;        var session5 = store.OpenSession(new SessionOptions&#xD;&#xA;        {&#xD;&#xA;            EnlistInAmbientTransactionScope = true,&#xD;&#xA;            OwnsTransactionLifecycle = false&#xD;&#xA;        });&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;</code></pre>

                </div>
                <hr />
                <nav class="related-links">
                    <span>
                        <strong>Previous: </strong><a href="/marten/documentation/documents/advanced/eject">Ejecting Documents from a Session</a>
                    </span>
                    <span class="pull-right">
                        <strong>Next: </strong><a href="/marten/documentation/documents/advanced/customizing_linq">Extending Marten's Linq Support</a>
                    </span>
                </nav>
            </div><!--/right-->
        </div><!--/row-->
    </div><!--/container-->
    <footer>
        <ul>
            <li>
                <a href="https://dotnetfoundation.org">
                    <img class="dot-net-foundation-logo" src="https://raw.githubusercontent.com/dotnet/swag/master/logo/dotnetfoundation_v4.png" alt="Supported by the .NET Foundation" />
                </a>
                Supported by the <a href="https://dotnetfoundation.org">.NET Foundation</a>
            </li>
        </ul>
    </footer>
</body>

<foot>
    <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type='text/javascript' src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/marten/content/prism.js"></script>
    <script type="text/javascript" src="/marten/content/sidebar.js"></script>
    <script type="text/javascript" src="/marten/content/affix.js"></script>

    <script>
        $('#search').keyup(function (e) {
            if (e.keyCode == 13) {
                var search = $('#search').val();

                var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
                url = encodeURI(url);

                //alert(url);

                window.location.href = url;

                e.stopPropagation();
                if (e.cancelBubble != null) e.cancelBubble = true;
                return false;
            }

        });
    </script>
</foot>
</html>
