<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Marten - Serializing with Newtonsoft.Json</title>
    <link href="/marten/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="/marten/content/prism.css" rel="stylesheet" type="text/css" />
    <link href="/marten/content/theme.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />

    <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

    <!-- CSS code from Bootply.com editor -->
    <link href="/marten/content/affix.css" rel="stylesheet" type="text/css" />
</head>

<!-- HTML code from Bootply.com editor -->

<body>
    <a href="https://github.com/jasperfx/marten"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

    <nav class="navbar navbar-default navbar-fixed-top" role="banner">
        <div class="container">
            <div class="navbar-header">
                <a href="/marten" class="navbar-brand">Marten 3.12.1</a>
            </div>
            <nav class="collapse navbar-collapse" role="navigation">
                <ul class="nav navbar-nav pull-right">
                    <li>
                        <a href="/marten/getting_started">Getting Started</a>
                    </li>
                    <li>
                        <a href="/marten/documentation">Documentation</a>
                    </li>
                    <li>
                        <a href="/marten/migration_guide">Migration Guide</a>
                    </li>
                    <li>
                        <a href="https://gitter.im/jasperfx/marten?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/marten" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/marten_lib?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @marten_lib</a>
                        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    </li>
                    <li><a href="/marten/documentation/documents/json/jil" title="Serializing with Jil">Previous</a></li>
                <li><a href="/marten/documentation/documents/advanced" title="Advanced Topics">Next</a></li>
                </ul>
                <div class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <input id="search" type="search" class="form-control" placeholder="Search">
                    </div>
                </div>
            </nav>
        </div>
    </nav>
    <div class="container">
        <nav class="navbar-inverse">
            <ol class="breadcrumb"><li><a href="/marten/">Marten</a></li><li><a href="/marten/documentation">Documentation</a></li><li><a href="/marten/documentation/documents">Marten as Document Db</a></li><li><a href="/marten/documentation/documents/json">Json Serialization</a></li><li class="active">Serializing with Newtonsoft.Json</li></ol>
        </nav>
    </div>
    <!--main-->
    <div class="container">
        <div class="row">
            <!--left-->

            <div class="col-md-3" id="leftCol">

                <img src="/content/images/emblem.png" width="80%" align="middle" />
                <br />
                <ul class="nav nav-stacked affix" id="sidebar"></ul>
                <h3 class="no-margin">Next</h3><p><a href="/marten/documentation/documents/advanced">Advanced Topics</a></p>
                    <h3 class="no-margin">Previous</h3><a href="/marten/documentation/documents/json/jil">Serializing with Jil</a></p>
                </ul>
            </div><!--/left-->
            <!--right-->
            <div class="col-md-9">
                <h1>Serializing with Newtonsoft.Json <a href="https://github.com/jasperfx/marten/blob/master/documentation/documentation/documents/json/newtonsoft.md" class="text-muted small pull-right fa fa-github" style="margin-top: 10px"> Edit on GitHub</a></h1>

                <hr />
                <div id="main-pane">
                    <!--Title: Serializing with Newtonsoft.Json-->
<p>The default JSON serialization strategy inside of Marten uses <a href="http://www.newtonsoft.com/json">Newtonsoft.Json</a>. We have standardized on Newtonsoft.Json
because of its flexibility and ability to handle polymorphism within child collections. Marten also uses Newtonsoft.Json internally to do JSON diff's for
the automatic dirty checking option.</p>
<p>Out of the box, Marten uses this configuration for Newtonsoft.Json:</p>
<pre><code class="language-csharp">&#xD;&#xA;private readonly JsonSerializer _serializer = new JsonSerializer&#xD;&#xA;{&#xD;&#xA;    TypeNameHandling = TypeNameHandling.Auto,&#xD;&#xA;&#xD;&#xA;    // ISO 8601 formatting of DateTime&#x27;s is mandatory&#xD;&#xA;    DateFormatHandling = DateFormatHandling.IsoDateFormat,&#xD;&#xA;    MetadataPropertyHandling = MetadataPropertyHandling.ReadAhead,&#xD;&#xA;    ContractResolver = new JsonNetContractResolver()&#xD;&#xA;};&#xD;&#xA;&#xD;&#xA;</code></pre>
<p>To customize the Newtonsoft.Json serialization, you need to explicitly supply an instance of Marten's <code>JsonNetSerializer</code> as shown below:</p>
<pre><code class="language-csharp">&#xD;&#xA;var serializer = new Marten.Services.JsonNetSerializer();&#xD;&#xA;&#xD;&#xA;// To change the enum storage policy to store Enum&#x27;s as strings:&#xD;&#xA;serializer.EnumStorage = EnumStorage.AsString;&#xD;&#xA;&#xD;&#xA;// All other customizations:&#xD;&#xA;serializer.Customize(_ =&gt;&#xD;&#xA;{&#xD;&#xA;    // Code directly against a Newtonsoft.Json JsonSerializer&#xD;&#xA;    _.DateTimeZoneHandling = DateTimeZoneHandling.RoundtripKind;&#xD;&#xA;    _.ConstructorHandling = ConstructorHandling.AllowNonPublicDefaultConstructor;&#xD;&#xA;});&#xD;&#xA;&#xD;&#xA;var store = DocumentStore.For(_ =&gt;&#xD;&#xA;{&#xD;&#xA;    _.Connection(&quot;some connection string&quot;);&#xD;&#xA;&#xD;&#xA;    // Replace the default JsonNetSerializer with the one we configured&#xD;&#xA;    // above&#xD;&#xA;    _.Serializer(serializer);&#xD;&#xA;});&#xD;&#xA;</code></pre>
<div class="alert alert-info">
You should not override the Newtonsoft.Json <code>ContractResolver</code> with <code>CamelCasePropertyNamesContractResolver</code> for Json Serialization. Newtonsoft.Json by default respects the casing used in property / field names which is typically PascalCase.
This can be overriden to serialize the names to camelCase and Marten will store the JSON in the database as specified by the Newtonsoft.Json settings. However, Marten uses the property / field names casing for its SQL queries and queries are case sensitive and as such, querying will not work correctly. 
</div>
<div class="alert alert-info">
Marten actually has to keep two Newtonsoft.Json serializers, with one being a "clean" Json serializer that omits all Type metadata. The need for two serializers is why
the customization is done with a nested closure so that the same configuration is always applied to both internal <code>JsonSerializer's</code>.
</div>
<h2 id="enum-storage">Enum Storage</h2>
<p>Marten allows how enum values are being stored. By default, they are stored as integers but it is possible to change that to storing them as strings.</p>
<p>To do that you need to change the serialization settings in the <code>DocumentStore</code> options.</p>
<pre><code class="language-csharp">&#xD;&#xA;&#xD;&#xA;var store = DocumentStore.For(_ =&gt;&#xD;&#xA;{&#xD;&#xA;    _.Connection(&quot;some connection string&quot;);&#xD;&#xA;&#xD;&#xA;    // Replace the default JsonNetSerializer default enum storage&#xD;&#xA;    // with storing them as string&#xD;&#xA;    _.UseDefaultSerialization(enumStorage: EnumStorage.AsString);&#xD;&#xA;});&#xD;&#xA;</code></pre>
<h2 id="fields-names-casing">Fields Names Casing</h2>
<p>Marten by default stores field names &quot;as they are&quot; (C# naming convention is PascalCase for public properties).</p>
<p>You can have them also automatically formatted to:</p>
<ul>
<li><code>CamelCase</code>,</li>
<li><code>snake_case</code>
by changing the serialization settings in the <code>DocumentStore</code> options.</li>
</ul>
<pre><code class="language-csharp">&#xD;&#xA;&#xD;&#xA;var store = DocumentStore.For(_ =&gt;&#xD;&#xA;{&#xD;&#xA;    _.Connection(&quot;some connection string&quot;);&#xD;&#xA;&#xD;&#xA;    // Replace the default (as is) JsonNetSerializer field names casing&#xD;&#xA;    // with camelCase formatting&#xD;&#xA;    _.UseDefaultSerialization(casing: Casing.CamelCase);&#xD;&#xA;});&#xD;&#xA;</code></pre>
<pre><code class="language-csharp">&#xD;&#xA;&#xD;&#xA;var store = DocumentStore.For(_ =&gt;&#xD;&#xA;{&#xD;&#xA;    _.Connection(&quot;some connection string&quot;);&#xD;&#xA;&#xD;&#xA;    // Replace the default (as is) JsonNetSerializer field names casing&#xD;&#xA;    // with snake_case formatting&#xD;&#xA;    _.UseDefaultSerialization(casing: Casing.SnakeCase);&#xD;&#xA;});&#xD;&#xA;</code></pre>
<h2 id="collection-storage">Collection Storage</h2>
<p>Marten by default stores the collections as strongly typed (so with $type and $value). Because of that and current <code>MartenQueryable</code> limitations, it might result in not properly resolved nested collections queries.</p>
<p>Changing the collection storage to <code>AsArray</code> using a custom <code>JsonConverter</code> will store it as regular JSON array for the following:</p>
<ul>
<li><code>ICollection&lt;&gt;</code>,</li>
<li><code>IList&lt;&gt;</code>,</li>
<li><code>IReadOnlyCollection&lt;&gt;</code>,</li>
<li><code>IEnumerable&lt;&gt;</code>.</li>
</ul>
<p>That improves the nested collections queries handling.</p>
<p>To do that you need to change the serialization settings in the <code>DocumentStore</code> options.</p>
<pre><code class="language-csharp">&#xD;&#xA;&#xD;&#xA;var store = DocumentStore.For(_ =&gt;&#xD;&#xA;{&#xD;&#xA;    _.Connection(&quot;some connection string&quot;);&#xD;&#xA;&#xD;&#xA;    // Replace the default (strongly typed) JsonNetSerializer collection storage&#xD;&#xA;    // with JSON array formatting&#xD;&#xA;    _.UseDefaultSerialization(collectionStorage: CollectionStorage.AsArray);&#xD;&#xA;});&#xD;&#xA;</code></pre>
<h2 id="non-public-members-storage">Non Public Members Storage</h2>
<p>By default <code>Newtonsoft.Json</code> only deserializes properties with public setters.</p>
<p>You can allow deserialisation of properties with non-public setters by changing the serialization settings in the <code>DocumentStore</code> options.</p>
<pre><code class="language-csharp">&#xD;&#xA;&#xD;&#xA;var store = DocumentStore.For(_ =&gt;&#xD;&#xA;{&#xD;&#xA;    _.Connection(&quot;some connection string&quot;);&#xD;&#xA;&#xD;&#xA;    // Replace the default (only public setters) JsonNetSerializer deserialization settings&#xD;&#xA;    // with allowing to also deserialize using non-public setters&#xD;&#xA;    _.UseDefaultSerialization(nonPublicMembersStorage: NonPublicMembersStorage.NonPublicSetters);&#xD;&#xA;});&#xD;&#xA;</code></pre>

                </div>
                <hr />
                <nav class="related-links">
                    <span>
                        <strong>Previous: </strong><a href="/marten/documentation/documents/json/jil">Serializing with Jil</a>
                    </span>
                    <span class="pull-right">
                        <strong>Next: </strong><a href="/marten/documentation/documents/advanced">Advanced Topics</a>
                    </span>
                </nav>
            </div><!--/right-->
        </div><!--/row-->
    </div><!--/container-->
    <footer>
        <ul>
            <li>
                <a href="https://dotnetfoundation.org">
                    <img class="dot-net-foundation-logo" src="https://raw.githubusercontent.com/dotnet/swag/master/logo/dotnetfoundation_v4.png" alt="Supported by the .NET Foundation" />
                </a>
                Supported by the <a href="https://dotnetfoundation.org">.NET Foundation</a>
            </li>
        </ul>
    </footer>
</body>

<foot>
    <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type='text/javascript' src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/marten/content/prism.js"></script>
    <script type="text/javascript" src="/marten/content/sidebar.js"></script>
    <script type="text/javascript" src="/marten/content/affix.js"></script>

    <script>
        $('#search').keyup(function (e) {
            if (e.keyCode == 13) {
                var search = $('#search').val();

                var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
                url = encodeURI(url);

                //alert(url);

                window.location.href = url;

                e.stopPropagation();
                if (e.cancelBubble != null) e.cancelBubble = true;
                return false;
            }

        });
    </script>
</foot>
</html>
